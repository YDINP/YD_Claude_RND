name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read
  checks: write

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr-info
        run: |
          # Î≥ÄÍ≤ΩÎêú ÌååÏùº Ïàò Í≥ÑÏÇ∞
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

          # ÌååÏùº ÌÉÄÏûÖÎ≥Ñ Î∂ÑÎ•ò
          TS_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(ts|tsx)$' | wc -l || echo 0)
          JS_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(js|jsx)$' | wc -l || echo 0)
          JSON_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.json$' | wc -l || echo 0)
          TEST_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E 'test\.(ts|js)$' | wc -l || echo 0)

          echo "ts_files=$TS_FILES" >> $GITHUB_OUTPUT
          echo "js_files=$JS_FILES" >> $GITHUB_OUTPUT
          echo "json_files=$JSON_FILES" >> $GITHUB_OUTPUT
          echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: true

      - name: Extract coverage percentage
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -p "Math.round(require('./coverage/coverage-summary.json').total.lines.pct)")
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "has_coverage=true" >> $GITHUB_OUTPUT
          else
            echo "has_coverage=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = ${{ steps.pr-info.outputs.changed_files }};
            const tsFiles = ${{ steps.pr-info.outputs.ts_files }};
            const jsFiles = ${{ steps.pr-info.outputs.js_files }};
            const jsonFiles = ${{ steps.pr-info.outputs.json_files }};
            const testFiles = ${{ steps.pr-info.outputs.test_files }};
            const hasCoverage = ${{ steps.coverage.outputs.has_coverage }};
            const coverage = ${{ steps.coverage.outputs.percentage || 0 }};

            let coverageBadge = '';
            if (hasCoverage) {
              const color = coverage >= 80 ? 'üü¢' : coverage >= 60 ? 'üü°' : 'üî¥';
              coverageBadge = `\n\n### Test Coverage\n${color} **${coverage}%**`;
            }

            const body = `## üîç PR Î∂ÑÏÑù Í≤∞Í≥º

            ### üìä Î≥ÄÍ≤Ω ÏÇ¨Ìï≠
            - **Ï¥ù ÌååÏùº Ïàò**: ${changedFiles}Í∞ú
            - TypeScript ÌååÏùº: ${tsFiles}Í∞ú
            - JavaScript ÌååÏùº: ${jsFiles}Í∞ú
            - JSON ÌååÏùº: ${jsonFiles}Í∞ú
            - ÌÖåÏä§Ìä∏ ÌååÏùº: ${testFiles}Í∞ú
            ${coverageBadge}

            ### ‚úÖ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
            ${testFiles > 0 ? '‚úÖ' : '‚ö†Ô∏è'} ÌÖåÏä§Ìä∏ ÌååÏùº Ìè¨Ìï®
            ${jsonFiles > 0 ? 'üìã Îç∞Ïù¥ÌÑ∞ ÌååÏùº Î≥ÄÍ≤ΩÎê® - \`validate:data\` ÌôïÏù∏ ÌïÑÏöî' : ''}

            ---
            *Automated PR check by ArcaneCollectors CI*
            `;

            // Í∏∞Ï°¥ Î¥á ÏΩîÎ©òÌä∏ Ï∞æÍ∏∞
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Î∂ÑÏÑù Í≤∞Í≥º')
            );

            if (botComment) {
              // Í∏∞Ï°¥ ÏΩîÎ©òÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.name,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // ÏÉà ÏΩîÎ©òÌä∏ ÏÉùÏÑ±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.name,
                issue_number: context.issue.number,
                body: body
              });
            }

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Check bundle size
        id: size
        run: |
          # dist Ìè¥ÎçîÏùò Ï¥ù ÏÇ¨Ïù¥Ï¶à Í≥ÑÏÇ∞
          TOTAL_SIZE=$(du -sh dist | cut -f1)
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT

          # Ï£ºÏöî ÌååÏùºÎì§Ïùò ÏÇ¨Ïù¥Ï¶à
          if [ -f dist/index.html ]; then
            HTML_SIZE=$(du -h dist/index.html | cut -f1)
            echo "html_size=$HTML_SIZE" >> $GITHUB_OUTPUT
          fi

      - name: Comment bundle size
        uses: actions/github-script@v7
        with:
          script: |
            const totalSize = '${{ steps.size.outputs.total_size }}';
            const htmlSize = '${{ steps.size.outputs.html_size }}' || 'N/A';

            const body = `## üì¶ Bundle Size

            - **Total**: ${totalSize}
            - **index.html**: ${htmlSize}

            ‚ÑπÔ∏è Build artifacts uploaded to workflow artifacts.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.name,
              issue_number: context.issue.number,
              body: body
            });
