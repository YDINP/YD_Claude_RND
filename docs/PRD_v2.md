# PRD v2: SubwayMate - 실시간 지하철 위치 추적 앱

## 1. 제품 개요

### 1.1 제품명
**SubwayMate** - 수도권 지하철 실시간 위치 기반 도착 알림 서비스

### 1.2 핵심 가치
> "지금 내가 어디쯤 있는지, 언제 내려야 하는지 한눈에!"

사용자가 출발역과 도착역을 설정하면:
1. 해당 노선의 **전체 역이 일렬로 표시**됨
2. **현재 위치가 실시간으로 업데이트**됨
3. 도착 N역 전에 **알림**으로 하차 안내

### 1.3 타겟 사용자
- 지하철에서 스마트폰 보다가 하차역 놓치는 사람
- 졸다가 목적지 지나치는 사람
- 처음 가는 경로라 현재 위치가 궁금한 사람

---

## 2. 핵심 기능

### 2.1 출발역/도착역 설정
- 역 검색 (한글 자동완성)
- 노선별 역 목록 보기
- 최근 검색역 표시
- 즐겨찾기 경로 저장

### 2.2 방향 선택
- 출발역→도착역 경로 분석
- 가능한 방향 제시 (상행/하행 또는 내선/외선)
- 소요 시간 및 역 개수 표시

### 2.3 ⭐ 실시간 노선도 (핵심 기능)
```
출발역부터 도착역까지의 모든 역을 세로로 일렬 표시

●━━ 강남 (출발)
┃
◉━━ 역삼 ◀━━ 현재 위치 🚇
┃
○━━ 선릉
┃
○━━ 삼성
┃
:
┃
◎━━ 신림 (도착) 🔔
```

**표시 요소:**
| 기호 | 의미 |
|------|------|
| ● | 출발역 (이미 지나감) |
| ◉ | 현재 역 |
| ○ | 아직 안 온 역 |
| ◎ | 도착역 |
| 🚇 | 현재 위치 표시 |
| 🔔 | 알림 설정된 역 |

**상태 표시:**
- "역삼역" - 역에 정차 중
- "선릉 → 삼성 이동 중" - 역 사이 이동 중

### 2.4 도착 알림
- N역 전 알림 (기본: 1역 전)
- 푸시 알림 + 소리 + 진동
- 잠금화면에서도 알림 표시
- 알림 반복 옵션

### 2.5 ⭐ 특정 역 알림 (신규)
- 노선도에서 **아무 역이나 탭**하여 알림 설정 가능
- 도착역 외에도 중간 역에 알림 설정 (예: 환승역)
- 각 역별로 몇 역 전 알림할지 개별 설정
- 알림 설정된 역은 🔔 아이콘으로 표시
- 여러 역에 동시 알림 설정 가능

### 2.5 즐겨찾기/최근 경로
- 경로 자동 저장 (최근 10개)
- 즐겨찾기 등록/해제
- 원터치로 같은 경로 시작

---

## 3. 화면 구성

### 3.1 메인 화면 (HomeScreen)
```
┌─────────────────────────────────────┐
│  SubwayMate          [설정]  [⭐]   │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────────────┐    │
│  │  📍 출발역 선택              │    │
│  └─────────────────────────────┘    │
│                                     │
│           ↓                         │
│                                     │
│  ┌─────────────────────────────┐    │
│  │  🎯 도착역 선택              │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────────┐│
│  │       [ 🚇 추적 시작 ]          ││
│  └─────────────────────────────────┘│
│                                     │
│  ─────────── 최근 경로 ───────────  │
│                                     │
│  ⭐ 강남 → 신림 (2호선)             │
│     홍대입구 → 을지로3가            │
│                                     │
└─────────────────────────────────────┘
```

**기능:**
- 출발역/도착역 선택 버튼
- 추적 시작 버튼
- 최근/즐겨찾기 경로 목록 (탭하면 바로 시작)

### 3.2 역 선택 화면 (StationSelectScreen)
```
┌─────────────────────────────────────┐
│  ← 출발역 선택                      │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │ 🔍 역 이름 검색...           │    │
│  └─────────────────────────────┘    │
│                                     │
│  ─────────── 최근 검색 ───────────  │
│  │ 강남 │ 신림 │ 홍대입구 │         │
│                                     │
│  ─────────── 노선 선택 ───────────  │
│  [1호선][2호선][3호선][4호선]...    │
│                                     │
│  ─────────── 역 목록 ───────────   │
│  ○ 시청                             │
│  ○ 을지로입구                       │
│  ○ 을지로3가                        │
│  ...                                │
└─────────────────────────────────────┘
```

**기능:**
- 검색창 (실시간 자동완성)
- 최근 검색 역 칩
- 노선 탭 (1~9호선, 기타 노선)
- 해당 노선 역 목록

### 3.3 방향 선택 화면 (DirectionSelectScreen)
```
┌─────────────────────────────────────┐
│  ← 방향 선택                        │
├─────────────────────────────────────┤
│                                     │
│      강남 → 신림 (2호선)            │
│                                     │
│  ┌─────────────────────────────┐    │
│  │  ○ 내선순환 (시청 방면)      │    │
│  │     12개역, 약 25분          │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │  ● 외선순환 (잠실 방면)  ✓   │    │
│  │     18개역, 약 35분          │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────────┐│
│  │       [ 이 방향으로 시작 ]       ││
│  └─────────────────────────────────┘│
│                                     │
└─────────────────────────────────────┘
```

**기능:**
- 가능한 방향 옵션 표시
- 각 방향별 역 개수/소요 시간
- 방향 선택 후 추적 시작

### 3.4 ⭐ 실시간 추적 화면 (TrackingScreen) - 핵심!
```
┌─────────────────────────────────────┐
│  ← 2호선 외선순환            [종료] │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────────────┐    │
│  │  🚇 현재 위치: 역삼역        │    │
│  │  🎯 도착역까지: 10개역 남음   │    │
│  │  ⏱️ 예상 도착: 약 22분       │    │
│  └─────────────────────────────┘    │
│                                     │
│  ════════════════════════════════   │
│                                     │
│     ●━━ 강남 (출발)                 │
│     ┃                               │
│    ◉━━ 역삼 ◀━━ 현재 🚇            │
│     ┃                               │
│     ○━━ 선릉                        │
│     ┃                               │
│     ○━━ 삼성                        │
│     ┃                               │
│     ○━━ 종합운동장                  │
│     ┃                               │
│     :    (스크롤)                   │
│     ┃                               │
│     ◎━━ 신림 (도착) 🔔              │
│                                     │
├─────────────────────────────────────┤
│  ⚙️ 알림: 1역 전 | 🔊 ON | 📳 ON   │
└─────────────────────────────────────┘
```

**핵심 기능:**
1. **현재 위치 실시간 표시**
   - 역 정차 시: "역삼역"
   - 이동 중: "역삼 → 선릉 이동 중"

2. **노선도 일렬 표시**
   - 출발역부터 도착역까지 모든 역
   - 지나간 역: ● (채워진 원)
   - 현재 역: ◉ (강조)
   - 남은 역: ○ (빈 원)
   - 도착역: ◎ (목표 표시)

3. **정보 카드**
   - 현재 위치
   - 남은 역 수
   - 예상 도착 시간

4. **알림 설정**
   - 하단에 간단히 표시
   - 탭하면 설정 변경

### 3.5 알림 화면 (AlertDialog)
```
┌─────────────────────────────────────┐
│                                     │
│         🔔 알림 🔔                  │
│                                     │
│      ⚠️ 1역 전입니다!               │
│                                     │
│      다음 역: 신림                  │
│      하차 준비하세요!               │
│                                     │
│  ┌───────────┐  ┌───────────┐      │
│  │   확인    │  │ 추적 종료  │      │
│  └───────────┘  └───────────┘      │
│                                     │
└─────────────────────────────────────┘
```

---

## 4. 데이터 흐름

### 4.1 위치 추적 로직
```
1. 사용자가 출발역/도착역/방향 선택
   ↓
2. 세션 생성 (RideSession)
   - 출발역, 도착역, 노선, 방향 저장
   - 경유 역 목록 계산
   ↓
3. 실시간 API 폴링 시작 (30초 간격)
   - 서울 열린데이터광장 실시간 열차 위치 API
   - 현재 역 정보 업데이트
   ↓
4. 현재 위치 업데이트
   - 노선도에서 현재 역 표시
   - 남은 역 수/시간 계산
   ↓
5. 알림 체크
   - 현재 위치가 도착역 N역 전이면 알림 발송
```

### 4.2 API 연동
```kotlin
// 서울 열린데이터광장 - 실시간 열차 위치
GET /api/subway/{apiKey}/json/realtimePosition/0/100/{lineId}

// 서울 열린데이터광장 - 실시간 도착 정보
GET /api/subway/{apiKey}/json/realtimeStationArrival/0/10/{stationName}
```

---

## 5. 기술 스택

| 영역 | 기술 |
|------|------|
| 언어 | Kotlin |
| UI | Jetpack Compose |
| 아키텍처 | MVVM + Clean Architecture |
| DI | Hilt |
| 네트워크 | Retrofit2 + Moshi |
| 로컬 DB | Room |
| 비동기 | Coroutines + Flow |
| 백그라운드 | Foreground Service + WorkManager |

---

## 6. 구현 우선순위

### Phase 1: 핵심 기능 (MVP)
1. ✅ 프로젝트 셋업
2. ✅ 역/노선 데이터 구축
3. ✅ 역 선택 화면
4. 🔄 실시간 노선도 화면 (수정 필요)
5. 🔄 실시간 위치 추적 (수정 필요)
6. ⬜ 도착 알림 기능

### Phase 2: 편의 기능
1. ✅ 즐겨찾기/최근 경로
2. ⬜ 방향 자동 추천
3. ⬜ 환승 안내

### Phase 3: 고도화
1. ⬜ 위젯
2. ⬜ 오프라인 모드
3. ⬜ 혼잡도 정보

---

## 7. 현재 문제점 및 수정 사항

### 7.1 현재 문제
1. **노선도가 일렬로 안 나옴** - 출발역~도착역 전체 역이 안 보임
2. **현재 위치 표시 안 됨** - 어느 역에 있는지 모름
3. **알림이 작동 안 함** - 도착 전 알림 없음

### 7.2 수정 필요 사항
1. TrackingScreen에 세로 노선도 UI 추가
2. 실시간 위치 업데이트 로직 수정
3. 알림 서비스 구현 확인

---

## 8. 다음 단계

1. **TrackingScreen UI 재설계**
   - 세로 노선도 컴포넌트 구현
   - 현재 위치 표시 로직

2. **위치 추적 로직 수정**
   - API 응답 → 현재 역 매핑
   - 역 사이 이동 중 상태 처리

3. **알림 기능 구현**
   - Foreground Service에서 알림 발송
   - 잠금화면 알림

4. **즐겨찾기 연동**
   - 추적 시작 시 자동 저장
   - 메인 화면에서 원터치 시작
